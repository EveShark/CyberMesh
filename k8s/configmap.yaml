apiVersion: v1
kind: ConfigMap
metadata:
  name: cybermesh-config
  namespace: cybermesh
  labels:
    app: consensus-backend
data:
  # Global Settings
  NODE_VERSION: "1.0.0"
  ENVIRONMENT: "development"
  NODE_TYPE: "validator"
  REGION: "gke"
  BLOCKCHAIN_NETWORK_ID: "cybermesh-dev"

  # Cluster Topology - All 5 Nodes
  CLUSTER_TOPOLOGY: "control:1,gateway:1,storage:1,observer:1,ingest:1"
  CONSENSUS_NODES: "1,2,3,4,5"
  TRUSTED_NODES: "1,2,3,4,5"
  QUORUM_SIZE: "3"
  CONSENSUS_MIN_QUORUM_SIZE: "3"

  # P2P Network
  P2P_ENCRYPTION: "true"
  P2P_PROTOCOL_PREFIX: "/cybermesh"
  P2P_LISTEN_PORT: "8001"
  P2P_ID_SEED_1: "59190a6b7f3339273ca1d94e63586da811ab85d49425b102ae447254e6c5f266"
  P2P_ID_SEED_2: "865681cce8708de4a097339a2517d7203eadfdfa5d60cb97d31677a43e56cdaa"
  P2P_ID_SEED_3: "d54c8756ae74c023244c8db4461fc0a4a44a437ae0d1e68444f2895e1f2565fd"
  P2P_ID_SEED_4: "6d0e83119c72cfb0788b3745211836e6c42e44de80896483e5ae3ec3f907ad6a"
  P2P_ID_SEED_5: "2aa90d3cf15d4e943906c4af7ac207e3a7afb2df90369ce3e1e4e909968f4103"
  RENDEZVOUS_NS: "cybermesh/k8s"
  P2P_BOOTSTRAP_PEERS: "/dns4/validator-0.validator-headless.cybermesh.svc.cluster.local/tcp/8001/p2p/12D3KooWH5qTumkGgHZSJZYP4bTot4g81r9x9C62vXa8oYZWjMTN,/dns4/validator-1.validator-headless.cybermesh.svc.cluster.local/tcp/8001/p2p/12D3KooWCMJ3v2p327mDuZo6d8PJvXUHFZrbuRkbUguC2GieDNSV,/dns4/validator-2.validator-headless.cybermesh.svc.cluster.local/tcp/8001/p2p/12D3KooWGSTWQmr29bCtJb1sFoC27pXakfeDtpGb22hQwmc7nQYt,/dns4/validator-3.validator-headless.cybermesh.svc.cluster.local/tcp/8001/p2p/12D3KooWRhGrFFpKic8M5rsNqsgtUXiyEd8dvLd1UuCXR4wafTyJ,/dns4/validator-4.validator-headless.cybermesh.svc.cluster.local/tcp/8001/p2p/12D3KooWD2z1iJ1WnBp7b9r4sN9c1d8yhXR21FpWrR4KrFUE2kUD"
  P2P_TOPICS: "consensus,blocks,txs"
  TRUSTED_P2P_PEERS: ""
  ALLOWED_IPS: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"

  # P2P Timing
  P2P_HEARTBEAT_INTERVAL: "5s"
  P2P_LIVENESS_TIMEOUT: "20s"
  P2P_DISCOVERY_INTERVAL: "15s"
  P2P_REPUTATION_DECAY_INTERVAL: "30s"
  P2P_QUARANTINE_TTL: "5m"
  PEER_TTL: "5m"
  DISCOVERY_INTERVAL: "30s"
  DYNAMIC_PEER_DISCOVERY: "true"

  # Database Connection (CockroachDB Cloud)
  DB_DSN: "postgresql://cybermesh_user:nO0wBjVYVSPPbUJQOqYstw@cybermesh-threats-8958.jxf.gcp-asia-southeast1.cockroachlabs.cloud:26257/cybermesh_threats?sslmode=require&sslrootcert=./certs/root.crt"
  DB_MAX_OPEN: "50"
  DB_MAX_IDLE: "10"
  DB_MAX_LIFETIME: "30m"
  DB_CONN_TIMEOUT: "5s"
  DB_TLS: "true"
  DB_CONNECTION_POOL: "50"
  DB_MAX_CONNECTIONS: "100"
  DB_IDLE_TIMEOUT: "5m"
  DB_QUERY_TIMEOUT: "5s"

  # Persistence
  PERSIST_QUEUE_SIZE: "1024"
  PERSIST_RETRY_MAX: "3"
  PERSIST_RETRY_BACKOFF_MS: "100"
  PERSIST_MAX_BACKOFF_MS: "5000"
  PERSIST_WORKERS: "1"
  PERSIST_SHUTDOWN_TIMEOUT: "30s"

  # Kafka (Confluent Cloud)
  ENABLE_KAFKA: "true"
  KAFKA_BOOTSTRAP_SERVERS: "pkc-ldvr1.asia-southeast1.gcp.confluent.cloud:9092"
  KAFKA_BROKERS: "pkc-ldvr1.asia-southeast1.gcp.confluent.cloud:9092"
  KAFKA_TLS_ENABLED: "true"
  KAFKA_SASL_MECHANISM: "PLAIN"

  # Kafka Topics
  KAFKA_INPUT_TOPICS: "ai.anomalies.v1,ai.evidence.v1,ai.policy.v1"
  KAFKA_OUTPUT_TOPIC_COMMITS: "control.commits.v1"
  KAFKA_DLQ_TOPIC: "ai.anomalies.v1.dlq"
  TOPIC_AI_ANOMALIES: "ai.anomalies.v1"
  TOPIC_AI_EVIDENCE: "ai.evidence.v1"
  TOPIC_AI_POLICY: "ai.policy.v1"
  TOPIC_CONTROL_COMMITS: "control.commits.v1"
  TOPIC_CONTROL_REPUTATION: "control.reputation.v1"
  TOPIC_CONTROL_POLICY: "control.policy.v1"
  TOPIC_CONTROL_EVIDENCE: "control.evidence.v1"
  TOPIC_DLQ: "ai.dlq.v1"

  # Kafka Settings
  KAFKA_TIMEOUT: "30s"
  KAFKA_MAX_TIMESTAMP_SKEW: "5m"
  KAFKA_MAX_MESSAGE_SIZE: "1048576"
  KAFKA_PRODUCER_ACKS: "all"
  KAFKA_PRODUCER_RETRIES: "10"
  KAFKA_PRODUCER_MAX_IN_FLIGHT: "5"
  KAFKA_PRODUCER_IDEMPOTENCE: "true"
  KAFKA_PRODUCER_COMPRESSION: "snappy"
  KAFKA_PRODUCER_BATCH_SIZE: "16384"
  KAFKA_PRODUCER_LINGER_MS: "10"
  KAFKA_PRODUCER_BUFFER_MEMORY: "33554432"
  KAFKA_CONSUMER_GROUP_ID: "cybermesh-consensus"
  KAFKA_CONSUMER_AUTO_OFFSET_RESET: "earliest"
  KAFKA_CONSUMER_MAX_POLL_RECORDS: "500"
  KAFKA_CONSUMER_SESSION_TIMEOUT: "30s"
  KAFKA_CONSUMER_HEARTBEAT_INTERVAL: "3s"

  # API Server
  API_BASE_PATH: "/api/v1"
  API_TLS_ENABLED: "false"
  API_TLS_CERT_FILE: "./certs/api-server.crt"
  API_TLS_KEY_FILE: "./certs/api-server.key"
  API_TLS_CLIENT_CA_FILE: "./certs/client-ca.crt"
  API_RATE_LIMIT_ENABLED: "true"
  API_RATE_LIMIT_REQUESTS: "100"
  API_RATE_LIMIT_WINDOW: "1m"
  API_CORS_ENABLED: "true"
  API_CORS_ALLOWED_ORIGINS: "*"
  API_REQUEST_TIMEOUT: "30s"

  # Mempool (consolidated - duplicates removed)
  MEMPOOL_MAX_TXS: "1000"
  MEMPOOL_MAX_BYTES: "10485760"
  MEMPOOL_NONCE_TTL: "15m"
  MEMPOOL_SKEW_TOLERANCE: "5m"
  MEMPOOL_RATE_PER_SECOND: "1000"

  # Consensus
  CONSENSUS_TIMEOUT: "2s"
  CONSENSUS_BLOCK_TIME: "5s"
  CONSENSUS_MAX_BLOCK_SIZE: "1048576"
  CONSENSUS_MAX_TXS_PER_BLOCK: "1000"
  VIEW_CHANGE_TIMEOUT: "10s"

  # Security Mode
  SECURITY_MODE: "strict"
  AES_ENCRYPTION_ENABLED: "true"
  JWT_ENABLED: "true"
  JWT_ISSUER: "https://cybermesh.k8s"
  JWT_AUDIENCE: "cybermesh-cluster"
  JWT_ALGORITHM: "HS256"
  JWT_EXPIRATION_SECONDS: "3600"
  AUTH_METHOD: "jwt"

  # Audit
  AUDIT_ENABLED: "true"
  AUDIT_LOG_PATH: "./logs/audit.log"

  # Metrics
  METRICS_ENABLED: "true"
  METRICS_PORT: "9100"

  # TLS Paths
  TLS_CERT_PATH: "certs/server.crt"
  TLS_KEY_PATH: "certs/server.key"
  MTLS_ENABLED: "false"

  # Crypto
  CRYPTO_AUDIT_ENABLED: "false"
  CRYPTO_STATIC_KEY_TTL: "8760h"
  CONTROL_SIGNING_DOMAIN: "control.commits.v1"
  CONTROL_SIGNING_KEY_ID: "node-1"
  CONTROL_SIGNING_KEY_CONTENT: |
    -----BEGIN PRIVATE KEY-----
    MC4CAQAwBQYDK2VwBCIEIJ9+Tzvc8NRF+rcWmUCwAC6HCLEtvc/I4FhvxcpyYXCR
    -----END PRIVATE KEY-----
  ED25519_DOMAIN_SEPARATION: "ai.v1"
  AI_DOMAIN_SEPARATION: "ai.v1"

  # Redis (Upstash Cloud)
  REDIS_HOST: "merry-satyr-14777.upstash.io"
  REDIS_PORT: "6379"
  REDIS_DB: "0"
  REDIS_TLS_ENABLED: "true"
  REDIS_MAX_CONNECTIONS: "10"
  FEEDBACK_REDIS_PIPELINE_SIZE: "1000"
  FEEDBACK_REDIS_TRANSACTION_RETRY: "3"
  FEEDBACK_CALIBRATION_REDIS_KEY: "calibration:model:current"

  # Consensus Algorithm
  CONSENSUS_ALGORITHM: "pbft"
  CONSENSUS_BASE_TIMEOUT: "2s"
  CONSENSUS_MIN_TIMEOUT: "1s"
  CONSENSUS_MAX_TIMEOUT: "60s"
  CONSENSUS_BLOCK_TIMEOUT: "5s"
  CONSENSUS_VIEWCHANGE_TIMEOUT: "30s"
  CONSENSUS_VOTE_TIMEOUT: "5s"

  # Consensus Features
  CONSENSUS_ENABLE_PROPOSING: "true"
  CONSENSUS_ENABLE_VOTING: "true"
  CONSENSUS_ENABLE_AIMD: "true"
  CONSENSUS_METRICS_ENABLED: "true"
  ADAPTIVE_TIMEOUT_ENABLED: "true"

  # Consensus Safety
  CONSENSUS_REQUIRE_QUORUM: "true"
  CONSENSUS_REQUIRE_JUSTIFY_QC: "true"
  CONSENSUS_STRICT_MONOTONICITY: "true"
  CONSENSUS_ALLOW_SELF_VOTING: "true"
  CONSENSUS_REQUIRE_UNIQUE_VOTERS: "true"
  CONSENSUS_STRICT_VALIDATION: "true"
  CONSENSUS_REJECT_FUTURE_MESSAGES: "true"

  # Node Reputation
  CONSENSUS_ENABLE_QUARANTINE: "true"
  CONSENSUS_ENABLE_REPUTATION: "true"
  NODE_REPUTATION_MIN_SCORE: "0.6"
  NODE_REPUTATION_DECAY_RATE: "0.01"

  # Heartbeat
  HEARTBEAT_INTERVAL: "500ms"
  CONSENSUS_HEARTBEAT_INTERVAL: "500ms"
  CONSENSUS_MAX_IDLE_TIME: "3s"
  CONSENSUS_MISSED_HEARTBEATS: "6"

  # State Management
  STATE_TIMESTAMP_SKEW: "30s"

  # Mempool Limits (already defined above)

  # Blockchain
  BLOCK_TIME: "5s"
  MAX_BLOCK_SIZE: "1048576"
  GAS_LIMIT: "10000000"
  CHAIN_DATA_PATH: "./data/chain"

  # Block Building
  BLOCK_MAX_TXS: "500"
  BLOCK_MAX_BYTES: "4194304"
  BLOCK_MIN_MEMPOOL_TXS: "1"
  BLOCK_BUILD_INTERVAL: "500ms"

  # API Settings
  ENABLE_API: "true"
  API_TLS_MIN_VERSION: "1.3"
  API_LISTEN_ADDR_AI: ":8080"
  API_HEALTH_PATH: "/health"
  API_METRICS_PATH: "/metrics"
  API_ADMIN_PATH_PREFIX: "/admin"

  # API Timeouts
  API_READ_TIMEOUT: "10s"
  API_WRITE_TIMEOUT: "30s"
  API_IDLE_TIMEOUT: "60s"
  API_SHUTDOWN_TIMEOUT: "30s"

  # API Access Control
  API_RBAC_ENABLED: "false"
  ALLOWED_CIDRS: "127.0.0.1/32,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"

  # Rate Limiting
  API_RATE_LIMIT_PER_MINUTE: "100"
  API_RATE_LIMIT_BURST: "10"
  RATE_LIMIT_GLOBAL_CAPACITY: "1000"
  RATE_LIMIT_GLOBAL_REFILL_RATE: "100.0"
  RATE_LIMIT_ANOMALY_CAPACITY: "500"
  RATE_LIMIT_ANOMALY_REFILL_RATE: "50.0"
  RATE_LIMIT_EVIDENCE_CAPACITY: "200"
  RATE_LIMIT_EVIDENCE_REFILL_RATE: "20.0"
  RATE_LIMIT_POLICY_CAPACITY: "100"
  RATE_LIMIT_POLICY_REFILL_RATE: "10.0"

  # API Features
  API_ENABLE_METRICS: "true"
  API_ENABLE_AUDIT: "true"
  API_ENABLE_PPROF: "false"
  API_MAX_REQUEST_SIZE: "1048576"
  API_MAX_HEADER_SIZE: "1048576"
  API_MAX_CONCURRENT_REQUESTS: "100"

  # AI/ML Models
  MODEL_DDOS_PATH: "data/models/ddos_lgbm_v1.0.0.pkl"
  MODEL_MALWARE_PATH: "data/models/malware_lgbm_v1.0.0.pkl"
  MODEL_HOT_RELOAD_ENABLED: "true"
  MODEL_RELOAD_CHECK_INTERVAL: "60"

  # Detection
  DETECTION_ENABLE_DDOS: "true"
  DETECTION_ENABLE_MALWARE: "true"
  DETECTION_DDOS_CONFIDENCE_THRESHOLD: "0.85"
  DETECTION_MALWARE_CONFIDENCE_THRESHOLD: "0.90"
  DETECTION_INTERVAL: "5"
  DETECTION_TIMEOUT: "30"
  TELEMETRY_BATCH_SIZE: "1000"
  MAX_DETECTIONS_PER_SECOND: "100"
  DDOS_THRESHOLD: "1000"
  MALWARE_TIMEOUT: "30s"

  # Feedback Loop
  FEEDBACK_LIFECYCLE_TTL_SECONDS: "2592000"
  FEEDBACK_ADMIT_TIMEOUT_SECONDS: "30"
  FEEDBACK_COMMIT_TIMEOUT_SECONDS: "300"
  FEEDBACK_LIFECYCLE_BATCH_SIZE: "1000"

  # Feedback Metrics Windows
  FEEDBACK_METRIC_WINDOW_REALTIME: "3600"
  FEEDBACK_METRIC_WINDOW_SHORT: "86400"
  FEEDBACK_METRIC_WINDOW_MEDIUM: "604800"
  FEEDBACK_METRIC_WINDOW_LONG: "2592000"

  # Feedback Minimum Samples
  FEEDBACK_MIN_SAMPLES_REALTIME: "100"
  FEEDBACK_MIN_SAMPLES_SHORT: "1000"
  FEEDBACK_MIN_SAMPLES_MEDIUM: "5000"
  FEEDBACK_MIN_SAMPLES_LONG: "20000"

  # Feedback Acceptance Rates
  FEEDBACK_ACCEPTANCE_RATE_CRITICAL: "0.40"
  FEEDBACK_ACCEPTANCE_RATE_LOW: "0.60"
  FEEDBACK_ACCEPTANCE_RATE_TARGET_MIN: "0.70"
  FEEDBACK_ACCEPTANCE_RATE_TARGET_MAX: "0.85"
  FEEDBACK_ACCEPTANCE_RATE_HIGH: "0.90"

  # Feedback Decay
  FEEDBACK_DECAY_HALF_LIFE_SECONDS: "86400"
  FEEDBACK_RATE_LIMIT_PER_ANOMALY: "10"
  FEEDBACK_RATE_LIMIT_PER_NODE: "10000"
  FEEDBACK_RATE_LIMIT_GLOBAL: "100000"
  FEEDBACK_CLOCK_SKEW_TOLERANCE_SECONDS: "300"

  # Feedback Security
  FEEDBACK_REQUIRE_SIGNATURE_FOR_BACKEND: "true"
  FEEDBACK_AUDIT_ALL_STATE_CHANGES: "true"

  # Feedback Calibration
  FEEDBACK_CALIBRATION_METHOD: "isotonic"
  FEEDBACK_CALIBRATION_MIN_SAMPLES: "1000"
  FEEDBACK_CALIBRATION_RETRAIN_INTERVAL: "3600"
  FEEDBACK_CALIBRATION_ACCEPTANCE_THRESHOLD: "0.60"
  FEEDBACK_CALIBRATION_MODEL_PATH: "data/models/calibration"
  FEEDBACK_CALIBRATION_SAVE_TO_REDIS: "true"

  # Limits & Constraints
  LIMITS_ANOMALY_MAX_SIZE: "262144"
  LIMITS_EVIDENCE_MAX_SIZE: "2097152"
  LIMITS_POLICY_MAX_SIZE: "131072"
  LIMITS_TIMESTAMP_SKEW_SECONDS: "60"
  LIMITS_NONCE_TTL_SECONDS: "900"
  LIMITS_NONCE_CLEANUP_INTERVAL_SECONDS: "60"

  # Circuit Breaker
  CIRCUIT_BREAKER_FAILURE_THRESHOLD: "5"
  CIRCUIT_BREAKER_TIMEOUT_SECONDS: "30"
  CIRCUIT_BREAKER_RECOVERY_THRESHOLD: "2"

  # Storage & Backup
  STORAGE_RETENTION_DAYS: "90"
  BACKUP_INTERVAL: "6h"
  BACKUP_RETENTION_DAYS: "90"
  BACKUP_COMPRESSION_LEVEL: "6"

  # Audit & Logging
  AUDIT_LOG_LEVEL: "info"
  LOG_LEVEL: "info"
  LOG_DEVELOPMENT: "false"
  LOG_FILE_PATH: "/app/logs/application.log"
  SERVICE_NAME: "cybermesh"
  
  # Log Rotation (lumberjack settings)
  LOG_MAX_SIZE: "100"        # MB per file
  LOG_MAX_BACKUPS: "10"      # Keep 10 rotated files
  LOG_MAX_AGE: "30"          # Days to retain old logs
  LOG_COMPRESS: "true"       # Compress rotated logs

  # Infrastructure
  PORT_RANGE_START: "8000"
  PORT_RANGE_SIZE: "100"
  PORT_RANDOMIZE: "false"
  METRICS_PATH: "/metrics"

  # Health Monitoring
  HEALTH_CHECK_INTERVAL: "30s"
  SLOW_QUERY_THRESHOLD: "5s"
  ALERTS_ENABLED: "false"

  # P2P Features
  ENABLE_P2P: "true"
  P2P_ALLOW_LOCAL_DISCOVERY: "true"

  # Development
  ALLOW_DEGRADED_BOOTSTRAP: "false"
