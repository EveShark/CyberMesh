apiVersion: batch/v1
kind: Job
metadata:
  name: delete-genesis-cert
  namespace: cybermesh
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: delete-cert
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          echo "Connecting to database..."
          PGPASSWORD="${DB_PASSWORD}" psql \
            -h "${DB_HOST}" \
            -p 26257 \
            -U cybermesh_user \
            -d cybermesh_threats \
            -c "DELETE FROM genesis_certificates;" \
            -c "SELECT COUNT(*) as remaining FROM genesis_certificates;"
          echo "Done!"
        env:
        - name: DB_HOST
          value: "cybermesh-threats-8958.jxf.gcp-asia-southeast1.cockroachlabs.cloud"
        - name: DB_PASSWORD
          value: "nO0wBjVYVSPPbUJQOqYstw"
        - name: PGSSLMODE
          value: "require"
