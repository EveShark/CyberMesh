apiVersion: batch/v1
kind: Job
metadata:
  name: clear-cockroachdb
  namespace: cybermesh
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      
      # Prefer stateless node (soft requirement)
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: workload-type
                operator: In
                values:
                - stateless
      
      containers:
      - name: clear-db
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          set -e
          echo "Connecting to CockroachDB..."
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # Use DATABASE_URL with fallback sslmode
          CONN=$(echo "${DATABASE_URL}" | sed 's/sslmode=verify-full/sslmode=require/')
          
          psql "${CONN}" << 'EOF'
          -- Clear ALL consensus and state data for full reset
          TRUNCATE TABLE transactions CASCADE;
          TRUNCATE TABLE blocks CASCADE;
          TRUNCATE TABLE state_versions CASCADE;
          TRUNCATE TABLE state_reputation CASCADE;
          TRUNCATE TABLE state_quarantine CASCADE;
          TRUNCATE TABLE state_policies CASCADE;
          TRUNCATE TABLE validators CASCADE;
          TRUNCATE TABLE audit_logs CASCADE;
          TRUNCATE TABLE consensus_votes CASCADE;
          TRUNCATE TABLE consensus_qcs CASCADE;
          TRUNCATE TABLE consensus_proposals CASCADE;
          TRUNCATE TABLE consensus_evidence CASCADE;
          TRUNCATE TABLE consensus_metadata CASCADE;
          
          -- Verify cleanup (all should show 0)
          SELECT 'blocks' as table_name, COUNT(*) as remaining FROM blocks
          UNION ALL
          SELECT 'transactions', COUNT(*) FROM transactions
          UNION ALL
          SELECT 'state_versions', COUNT(*) FROM state_versions
          UNION ALL
          SELECT 'state_reputation', COUNT(*) FROM state_reputation
          UNION ALL
          SELECT 'state_quarantine', COUNT(*) FROM state_quarantine
          UNION ALL
          SELECT 'state_policies', COUNT(*) FROM state_policies
          UNION ALL
          SELECT 'validators', COUNT(*) FROM validators
          UNION ALL
          SELECT 'audit_logs', COUNT(*) FROM audit_logs
          UNION ALL
          SELECT 'consensus_proposals', COUNT(*) FROM consensus_proposals
          UNION ALL
          SELECT 'consensus_qcs', COUNT(*) FROM consensus_qcs
          UNION ALL
          SELECT 'consensus_votes', COUNT(*) FROM consensus_votes
          UNION ALL
          SELECT 'consensus_evidence', COUNT(*) FROM consensus_evidence
          UNION ALL
          SELECT 'consensus_metadata', COUNT(*) FROM consensus_metadata;
          EOF
          
          echo "Database cleanup complete!"
        env:
        # Database connection string from Secret
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: cybermesh-secrets
              key: DATABASE_URL
